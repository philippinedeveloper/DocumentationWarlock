<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocumentationWarlock with Blockly</title>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #2b2d42, #8d99ae, #edf2f4);
            background-size: 300% 300%;
            animation: gradient 6s ease infinite;
            color: #fff;
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            width: 520px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        h2 {
            text-align: center;
            font-size: 24px;
            margin-bottom: 10px;
        }

        p {
            text-align: center;
            margin-bottom: 20px;
            font-size: 14px;
        }

        input[type="file"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            background: #4caf50;
            color: white;
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            display: none;
        }

        .progress {
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, #6a0572, #ad5389);
            transition: width 0.4s ease-in-out;
        }

        textarea {
            width: 100%;
            height: 200px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            padding: 10px;
            font-family: monospace;
            font-size: 14px;
            resize: none;
            margin-bottom: 20px;
            overflow-y: auto;
        }

        button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(90deg, #6a0572, #ad5389);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: background 0.3s ease-in-out;
        }

        button:hover {
            background: linear-gradient(90deg, #ad5389, #6a0572);
        }

        button:active {
            transform: scale(0.98);
        }

        .hidden {
            display: none;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
<div class="container">
    <h2>DocumentationWarlock</h2>
    <p>Select an .aix file to generate documentation:</p>
    <input type="file" id="fileInput" accept=".aix" />
    <div class="progress-bar" id="progressBar">
        <div class="progress" id="progress"></div>
    </div>
    <textarea id="result" readonly placeholder="Generated documentation will appear here..."></textarea>
    <button id="generate">Generate Documentation</button>
    <label for="blockStyle">Choose Block Style:</label>
    <select id="blockStyle">
        <option value="mit">MIT App Inventor</option>
        <option value="kodular">Kodular</option>
        <option value="niotron">Niotron</option>
    </select>
    <button id="download">Download Blockly Blocks ZIP</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://unpkg.com/blockly/blockly.min.js"></script>
<script>
    const fileInput = document.getElementById('fileInput');
    const progressBar = document.getElementById('progressBar');
    const progress = document.getElementById('progress');
    const result = document.getElementById('result');
    const generateButton = document.getElementById('generate');
    const downloadButton = document.getElementById('download');
    const blockStyleSelector = document.getElementById('blockStyle');

    let selectedFile = null;
    let blocksXML = [];

    fileInput.addEventListener('change', (event) => {
        selectedFile = event.target.files[0];
    });

    generateButton.addEventListener('click', () => {
        if (!selectedFile) {
            alert('Please choose an .aix file!');
            return;
        }
        
        const reader = new FileReader();

        reader.onload = async (e) => {
            progressBar.style.display = 'block';
            progress.style.width = '10%';

            try {
                const zip = await JSZip.loadAsync(e.target.result);
                const componentsJsonFile = Object.keys(zip.files).find(file => file.endsWith('components.json'));

                if (!componentsJsonFile) {
                    throw new Error('components.json not found in the .aix file');
                }

                progress.style.width = '30%';
                const componentsContent = await zip.file(componentsJsonFile).async('text');
                const components = JSON.parse(componentsContent);

                let documentation = '';
                blocksXML = [];

                components.forEach((component, index) => {
                    documentation += `<h2>Docs for: ${component.name}</h2>`;

                    if (component.events.length) {
                        documentation += '<h3>Events</h3>';
                        component.events.forEach(event => {
                            documentation += `<h4>${event.name}</h4><p>${event.description}</p>`;
                            if (event.params.length) {
                                documentation += '<table border="1"><tr><th>Param</th><th>Type</th></tr>';
                                event.params.forEach(param => {
                                    documentation += `<tr><td>${param.name}</td><td>${param.type}</td></tr>`;
                                    createBlockForEvent(event, param);
                                });
                                documentation += '</table>';
                            }
                        });
                    }

                    if (component.methods.length) {
                        documentation += '<h3>Methods</h3>';
                        component.methods.forEach(method => {
                            documentation += `<h4>${method.name}</h4><p>${method.description}</p>`;
                            if (method.params.length) {
                                documentation += '<table border="1"><tr><th>Param</th><th>Type</th></tr>';
                                method.params.forEach(param => {
                                    documentation += `<tr><td>${param.name}</td><td>${param.type}</td></tr>`;
                                    createBlockForMethod(method, param);
                                });
                                documentation += '</table>';
                            }
                            if (method.returnType) {
                                documentation += `<p>Return type: ${method.returnType}</p>`;
                            }
                        });
                    }
                });

                result.value = documentation;
                progress.style.width = '100%';
            } catch (error) {
                alert(error.message);
            } finally {
                progressBar.style.display = 'none';
                progress.style.width = '0';
            }
        };

        reader.readAsArrayBuffer(selectedFile);
    });

    function createBlockForEvent(event, param) {
        const blockStyle = blockStyleSelector.value === 'mit' ? 'mit_style' :
                           blockStyleSelector.value === 'kodular' ? 'kodular_style' :
                           'niotron_style';
        
        const block = {
            type: 'event_block',
            message0: event.name,
            args0: [{
                type: 'input_value',
                name: 'PARAM',
                check: 'String'
            }],
            style: blockStyle,
            id: event.name
        };
        
        blocksXML.push(block);
    }

    function createBlockForMethod(method, param) {
        const blockStyle = blockStyleSelector.value === 'mit' ? 'mit_style' :
                           blockStyleSelector.value === 'kodular' ? 'kodular_style' :
                           'niotron_style';

        const block = {
            type: 'method_block',
            message0: method.name,
            args0: [{
                type: 'input_value',
                name: 'PARAM',
                check: 'String'
            }],
            style: blockStyle,
            id: method.name
        };

        blocksXML.push(block);
    }

    downloadButton.addEventListener('click', () => {
        if (blocksXML.length === 0) {
            alert('No blocks to download!');
            return;
        }

        const zip = new JSZip();
        
        blocksXML.forEach((block, index) => {
            zip.file(`block_${index + 1}.xml`, JSON.stringify(block));
        });

        zip.generateAsync({ type: 'blob' })
            .then(function (content) {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = 'blockly_blocks.zip';
                link.click();
            });
    });
</script>
</body>
</html>
